{% extends "base.html" %}

{% block title %}Live Dashboard - Smart Queue System{% endblock %}

{% block content %}
<div class="hero" style="padding: 2rem 1rem;">
    <h1 class="hero-title" style="font-size: 2rem;">üìä Live Hospital Dashboard</h1>
    <p class="hero-subtitle" style="font-size: 1rem;">
        Real-time queue monitoring and crowd level tracking
    </p>
</div>

<div class="container">
    <!-- Hospital Overview Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="totalWaiting">-</div>
            <div class="stat-label">Patients Waiting</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalServed">-</div>
            <div class="stat-label">Patients Served</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalPatients">-</div>
            <div class="stat-label">Total Today</div>
        </div>
    </div>

    <!-- Overall Hospital Crowd Level -->
    <div class="card">
        <div style="text-align: center;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937;">
                Overall Hospital Status
            </h2>
            <div id="hospitalCrowdLevel" style="font-size: 1.25rem;">
                <span class="badge badge-success">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Department-wise Queue Tables -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Department-wise Queue Status</h2>
            <p class="card-subtitle">Live updates every 5 seconds</p>
        </div>

        <div id="departmentGrid" class="grid">
            <!-- Department cards will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- Waiting Patients List -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Waiting Patients</h2>
            <p class="card-subtitle">All patients currently in queue</p>
        </div>

        <div id="patientsList">
            <!-- Patient list will be inserted here by JavaScript -->
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <p style="color: #6b7280; font-size: 0.875rem; margin: 0;">
                <strong>Last Updated:</strong> <span id="lastUpdate">Just now</span>
            </p>
            <a href="{{ url_for('landing') }}" class="btn btn-secondary" style="width: auto; min-width: 150px;">
                ‚Üê Back to Home
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function updateDashboard() {
        try {
            // Fetch hospital overview
            const overviewResponse = await fetch('/api/hospital_overview');
            const overviewData = await overviewResponse.json();

            document.getElementById('totalWaiting').textContent = overviewData.total_waiting;
            document.getElementById('totalServed').textContent = overviewData.total_served;
            document.getElementById('totalPatients').textContent = overviewData.total_patients;

            document.getElementById('hospitalCrowdLevel').innerHTML =
                `<span class="badge badge-${overviewData.crowd_color}" style="font-size: 1.25rem; padding: 0.75rem 1.5rem;">
                ${overviewData.crowd_level} Crowd Level
            </span>`;

            // Fetch department status
            const deptResponse = await fetch('/api/department_status');
            const deptData = await deptResponse.json();

            // Build department cards
            const departmentGrid = document.getElementById('departmentGrid');
            departmentGrid.innerHTML = '';

            deptData.forEach(dept => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.margin = '0';

                // Department icon mapping
                const icons = {
                    'Doctor Consultation': 'üë®‚Äç‚öïÔ∏è',
                    'Pharmacy / Medicine Pickup': 'üíä',
                    'Blood Test / Laboratory': 'ü©∏',
                    'Radiology / Scanning (X-ray, MRI, CT)': 'üî¨',
                    'Medical Report Collection': 'üìÑ'
                };

                card.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">
                        ${icons[dept.name] || 'üè•'} ${dept.name}
                    </h3>
                    <span class="badge badge-${dept.crowd_color}">${dept.crowd_level}</span>
                </div>
                
                <div style="display: grid; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Queue Count</span>
                        <strong style="color: #1f2937; font-size: 1.125rem;">${dept.queue_count}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Avg. Wait Time</span>
                        <strong style="color: #2563eb; font-size: 1.125rem;">${dept.avg_waiting_time} min</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Service Time</span>
                        <strong style="color: #6b7280; font-size: 1rem;">${dept.average_service_time} min</strong>
                    </div>
                </div>
            `;

                departmentGrid.appendChild(card);
            });

            // Fetch and display waiting patients
            const patientsResponse = await fetch('/api/waiting_patients');
            const patientsData = await patientsResponse.json();

            const patientsList = document.getElementById('patientsList');

            if (patientsData.length === 0) {
                patientsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <p style="font-size: 1.125rem;">No patients currently waiting</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Queue is empty</p>
                    </div>
                `;
            } else {
                patientsList.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Queue #</th>
                                    <th>Position</th>
                                    <th>Wait Time</th>
                                    <th>Registered</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                            </tbody>
                        </table>
                    </div>
                `;

                const tbody = document.getElementById('patientsTableBody');
                patientsData.forEach(patient => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${patient.name}</strong></td>
                        <td>${patient.department}</td>
                        <td><span class="badge badge-primary">${patient.queue_number}</span></td>
                        <td>${patient.position}</td>
                        <td>${patient.waiting_time} min</td>
                        <td>${patient.timestamp}</td>
                        <td>
                            <button class="btn btn-secondary leave-btn" 
                                data-patient-id="${patient.id}" 
                                data-patient-name="${patient.name}"
                                style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
                                       padding: 0.5rem 1rem; 
                                       font-size: 0.875rem;
                                       min-height: 36px;
                                       width: auto;">
                                üö™ Leave
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Add event listeners to all leave buttons
                document.querySelectorAll('.leave-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const patientId = e.target.dataset.patientId;
                        const patientName = e.target.dataset.patientName;

                        if (confirm(`Remove ${patientName} from the queue?`)) {
                            e.target.textContent = 'Leaving...';
                            e.target.disabled = true;

                            try {
                                const response = await fetch('/api/leave_queue', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ patient_id: parseInt(patientId) })
                                });

                                const data = await response.json();

                                if (data.success) {
                                    // Refresh dashboard immediately
                                    updateDashboard();
                                } else {
                                    alert('Error: ' + (data.error || 'Failed to remove patient'));
                                    e.target.textContent = 'üö™ Leave';
                                    e.target.disabled = false;
                                }
                            } catch (error) {
                                alert('Failed to remove patient. Please try again.');
                                console.error('Error:', error);
                                e.target.textContent = 'üö™ Leave';
                                e.target.disabled = false;
                            }
                        }
                    });
                });
            }

            // Update timestamp
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();

        } catch (error) {
            console.error('Error updating dashboard:', error);
        }
    }

    // Initial load
    updateDashboard();

    // Auto-refresh every 5 seconds
    setInterval(updateDashboard, 5000);
</script>
{% endblock %}